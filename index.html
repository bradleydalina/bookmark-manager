<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta name="viewport" content="width=device-width">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>Bookmark Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
	integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<style>
		@import url("//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css");
		@import url("//cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css");
		@import url("https://fonts.googleapis.com/css?family=Raleway:300,300italic,500,500italic");

		* {
			margin: 0;
			padding: 0;
			font-family: Raleway, Helvetica, sans-serif;
			font-size: 18pt;
			font-weight: 300;
			line-height: 1.75;
			letter-spacing: .025em;
			box-sizing: border-box;
			font-size: 14px;
		}

		body {
			-webkit-font-smoothing: antialiased;
			-webkit-text-size-adjust: none;
			width: 100% !important;
			height: 100% !important;
			line-height: 1.6;
			background-color: #f6f6f6;
		}

		#main,
		#main>tr,
		#main>tr>td {
			height: 100%;
			width: 100%;
			position: absolute;
		}

		.dashboard {
			display: flex !important;
			max-width: 1270px !important;
			clear: both !important;
			flex-direction: column;
			height: calc(100% - 60px);
			width: calc(100% - 60px);
			margin: 30px auto;
		}

		.container {
			display: flex !important;
			align-items: start;
			justify-contents: center;
		}
    ul.navigation li{line-height:30px;}
	  ul.navigation li a{text-decoration:none; cursor:hand; color:#1d1d1d;transition: color linear 200ms;}
	  ul.navigation li a:hover{color:#1d1d1d73;transition: color linear 200ms;}
		h1,
		h2,
		h3 {
			color: #000;
			margin: 40px 0 0;
			line-height: 1.2;
			font-weight: 400;
		}

		h1 {
			font-size: 32px;
			font-weight: 500;
		}

		h2 {
			font-size: 24px;
		}

		h3 {
			font-size: 18px;
		}

		h4 {
			font-size: 14px;
			font-weight: 600;
		}

		textarea,
		select,
		input[type='text'],
		input[type='search'],
		input[type='password'],
		input[type='file'],
		input[type='email'],
		input[type='number'] {
			line-height: 32px;
			padding: 2px 5px !important;
			height: 32px;
			border-radius: 0px !important;
			outline: 0;
		}

		.spinner {
			margin: 10px auto;
			width: 50px;
			height: 30px;
			text-align: center;
			font-size: 10px;
		}

		.spinner>div {
			background-color: #333;
			height: 100%;
			width: 6px;
			display: inline-block;

			-webkit-animation: sk-stretchdelay 1.2s infinite ease-in-out;
			animation: sk-stretchdelay 1.2s infinite ease-in-out;
		}

		.spinner .rect2 {
			-webkit-animation-delay: -1.1s;
			animation-delay: -1.1s;
		}

		.spinner .rect3 {
			-webkit-animation-delay: -1.0s;
			animation-delay: -1.0s;
		}

		.spinner .rect4 {
			-webkit-animation-delay: -0.9s;
			animation-delay: -0.9s;
		}

		.spinner .rect5 {
			-webkit-animation-delay: -0.8s;
			animation-delay: -0.8s;
		}

		@-webkit-keyframes sk-stretchdelay {

			0%,
			40%,
			100% {
				-webkit-transform: scaleY(0.4)
			}

			20% {
				-webkit-transform: scaleY(1.0)
			}
		}

		@keyframes sk-stretchdelay {

			0%,
			40%,
			100% {
				transform: scaleY(0.4);
				-webkit-transform: scaleY(0.4);
			}

			20% {
				transform: scaleY(1.0);
				-webkit-transform: scaleY(1.0);
			}
		}
    .modal .modal-body {
      background: #f8fafb;
    }
    .modal .modal-header {
      padding: 30px 15px;
      text-align: center;
      display: block;
      }
    .modal .modal-title {
    font-size: 26px;
    color:#676a6c;
    }
    .btn{
      border-radius:3px;
      }
      .btn-light{border:solid 1px #ddd; color:#1d1d1d;}
      .form-control:focus, .form-check-input:focus{box-shadow:none;border-color:#1d1d1d77;}
	</style>
	<link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css" />
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"
		integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
	<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous">
</script>
</head>

<body>
	<table id="main">
		<tr>
			<td>
				<div class="dashboard">
					<h1 style="margin-bottom:5px;margin-top:0;">Bookmark Manager</h1>
          <div class="breadcrumbs" style="margin-bottom:35px;">Your bookmark collection is now safe.</div>
					<div class=" row container">
						<aside class="col-md-3" style="">
							<h3 class="text-bold" style="margin-top:0; color:#adadad; margin-bottom:20px;">Navigation
							</h3>
							<ul class="navigation" style="list-style-type:none; margin-left:20px;">
				        <li><a href="#new-record-modal" type="button" data-bs-toggle="modal" data-bs-target="#new-record-modal"><i class="fa fa-plus-square" style="display:inline;"></i> &nbsp;New</a></li>
								<li><a href=""><i class="fa fa-folder" style="display:inline;"></i> &nbsp;Records</a></li>
								<li><a href=""><i class="fa fa-layer-group" style="display:inline;"></i> &nbsp;Categories</a></li>
							</ul>
						</aside>
						<main class="col-md-9">
							<!-- <h3 class="text-bold" style="margin-top:0; color:#adadad; margin-bottom:20px;">Table</h3> -->
		        	<div class="breadcrumbs d-sm-none d-md-block" style="margin-bottom:20px;"><small style="font-weight:400; color:#adadad;">Home > <a href="">Records</a></small></div>
							<table id="record_tbl" class="table table-condensed table-striped table-hover display"
								style="width:100%">
								<thead>
									<tr>
										<th>Title</th>
										<th>Link</th>
										<th>Category</th>
										<th>Priority</th>
										<th>Created</th>
										<th>Action</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td colspan="6" style="text-align:center;">
											Please wait ...
											<div class="spinner">
												<div class="rect1"></div>
												<div class="rect2"></div>
												<div class="rect3"></div>
												<div class="rect4"></div>
												<div class="rect5"></div>
											</div>
										</td>
									</tr>
								</tbody>
							</table>
						</main>
					</div>
				</div>
			</td>
		</tr>
	</table>
  <!-- Modal -->
  <div class="modal fade" id="new-record-modal" tabindex="-1" aria-labelledby="new-record-modal-title" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content rounded-1">
        <div class="modal-header">
		      <button style="position: absolute; right: 20px; top: 15px;" type="button" class="btn-close" data-bs-dismiss="modal"><span class="sr-only">Close</span></button>
          <h4 id="new-record-modal-title" class="modal-title fs-5" data-title="Add new user">Add new user</h4>
          <small id="new-record-modal-message" class="modal-message font-bold" data-message="Please enter the following input fields.">Please enter the following input
		                        fields.</small>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="title" class="form-label">Title <span class="title-error text-danger fst-italic"></span></label>
            <input type="text" class="form-control" id="title" placeholder="Bookmark title" required autocomplete="on">
          </div>
          <div class="mb-3">
            <label for="link" class="form-label">Link <span class="link-error text-danger fst-italic">(https://)</span></label>
            <input type="text" class="form-control" id="link" placeholder="URL link" required>
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">Category <span class="category-error text-danger fst-italic"></span></label>
            <select class="form-control" id="category" required>
            <option value="">Select</option>
			      <option value="add-new">Add new</option>
            </select>
			      <input type="text" class="form-control" id="category-new" placeholder="Category" style="display:none;">
          </div>
          <div class="mb-3">
            <label for="priority" class="form-label">Priority <span class="priority-error text-danger fst-italic"></span></label>
            <select class="form-control" id="priority">
            <option value="1" selected>1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            </select>
          </div>
		      <br/>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="" id="withlogin">
            <label class="form-check-label" for="withlogin">
              With login accounts?
            </label>
          </div>
          <div class="extra-inputs" style="display:none;">
            <br/>
            <div class="mb-3">
              <label for="username" class="form-label">Username <span class="priority-error text-danger fst-italic"></span></label>
              <input type="text" class="form-control" id="username" placeholder="Username">
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password <span class="priority-error text-danger fst-italic"></span></label>
              <div class="input-group">				      
              <input type="password" class="form-control" id="password" placeholder="••••••••">
			        <span class="show-hide-password input-group-text"><i class="fa fa-eye"></i></span>
              </div>
            </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-light btn-flat" id="new-record-close" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-secondary btn-flat" id="new-record-save">Save record</button>
        </div>
      </div>
    </div>
  </div>
	<script type="module">
      'use_strict';
	    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';	
      const supabaseUrl = 'https://zuupkqewxaxdwepasuai.supabase.co';
      const supabase = createClient(supabaseUrl,
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp1dXBrcWV3eGF4ZHdlcGFzdWFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTg3NjM1ODksImV4cCI6MjAzNDMzOTU4OX0.icXtvncapWLxHYdVz94aaefetE73vNmBnJqBabDLOhU');
      
      var record_data = [];
      var categories_data= [];

      async function fetchCategories(table) {
          try{
              const { data, error } = await supabase.from(table).select(`id, title, created_at`);
              //console.log(error);
              if(error) throw error;
              return data;
          } catch (error) {
              return [];
          }
      }
	
      async function fetchRecords(table) {
          try{
              const { data, error } = await supabase.from(table).select(`id, title, link, priority, created_at,
              category_tbl:category_id(title)`);
              //console.log(error);
              if(error) throw error;
          return data;
          } catch (error) {
              return [];
          }
      }

      async function addCategory(title){
          try {
          let { data, error, statusText } = await supabase
          .from('category_tbl')
          .insert({
              title: title //$("#category").text()
              }).select();
              if(error) throw error;
              return data[0];
              //addRecord(data[0].id);
          } catch (error) {
              $("#new-record-modal-title").text("Error saving the new record").css({"color":"#ff0000"});
              $("#new-record-modal-message").text(JSON.stringify(error));              
              return [];
          }
      }

      async function addRecord(data){
          try {
              let { error, statusText } = await supabase
              .from('record_tbl')
              .insert(data);
              if(error) throw error;
              $("#new-record-modal-title").text("New bookmark record saved").css({"color":"#ff0000"});
              
              reDrawRecordTable(await fetchAndDrawRecordTable());
              
              setTimeout(function(){
              $("#new-record-close").trigger('click');
              }, 3000);
          } catch (error) {
              $("#new-record-modal-title").text("Error saving the new record").css({"color":"#ff0000"});
              $("#new-record-modal-message").text(JSON.stringify(error));
              return false;
          }
      }

	    categories_data = await fetchCategories('category_tbl').then(function(data){            
            data.forEach(function(index){
                  index.created_at = new Date(index.created_at).toLocaleDateString('en-us', { weekday:"long", year:"numeric", month:"long", day:"numeric"});
                  index.action="<button data-toggle='modal' data-target='#view-record-modal' class='action-btn view-record-btn btn btn-sm btn-light' data-toggle='tooltip' data-placement='top' title='View' id='' data=''><i class='fa fa-eye'></i></button>";
                  index.title = capitalizeWord(index.title);
                  return index;
            })
            return data;
      }).then(async function(categories_data){
            record_data = await fetchRecords('record_tbl').then(function(data){
                  //console.log(data);
                  data.forEach(function(index){
                      index.link = "<a href='"+index.link+"' target='_blank'>"+(index.link.length > 50 ? index.link.slice(0, 50-1) +
                        '&hellip;' : index.link) +"</a>";
                      index.created_at = new Date(index.created_at).toLocaleDateString('en-us', { weekday:"long", year:"numeric",
                      month:"long", day:"numeric"});
                      index.action="<button data-toggle='modal' data-target='#view-record-modal' class='action-btn view-record-btn btn btn-sm btn-light' data-toggle='tooltip' data-placement='top' title='View' id='' data=''><i class='fa fa-eye'></i></button>";
                      index.category = capitalizeWord(index.category_tbl.title);
                      return index;
                  })
                  return data;
            });
            return {record: record_data,categories:categories_data};
	    }).then(function(data){
          $(document).ready( function () { 
              const recordTable = $('#record_tbl').DataTable({
                  "searching": true,
                  "aoColumnDefs": [
                      { "bSortable": false, "aTargets": [ 1, 5] },
                  ],
                  data: data.record,
                  "lengthMenu": [ [10, 25, 50, -1], [10, 25, 50, "All"] ],
                  "order": [[ 2, "asc" ], [3, "desc"]],
                  "autoWidth": true,
                  "responsive": true,
                  columns:[
                      { data: 'title', className: 'dt-expand'},
                      { data: 'link' ,className: 'dt-expand'},
                      { data: 'category' ,className: 'dt-expand'},
                      { data: 'priority' ,className: 'dt-expand'},
                      { data: 'created_at' ,className: 'dt-expand'},
                      { data: 'action'},
                  ]
              });
          function reDrawRecordTable(record_data){
              $("#category-filter").remove();
              $("#priority-filter").remove();
              $(".dt-search").append(" <select id='category-filter' class='dt-input'><option>Select...</option></select>");
              $(".dt-search").append(" <select id='priority-filter' class='dt-input'><option>Select...</option></select>");

                    recordTable.clear().rows.add(record_data).draw();
                    recordTable.columns("2").every(function () {
                      var column = this;
                      //console.log(column);
                      let select = $('#category-filter').on('change', function () {
                          if($(this).val().length > 0 && $(this).val()!='Select...'){
                              var val = $.fn.dataTable.util.escapeRegex($('option:selected',this).text());
                              column.search(val ? '^' + val + '$' : '', true, false).draw();//
                          }else{
                              column.search('').draw();
                          }
                      });
                      select.find('option').not(':first').remove();
                      column
                      .data()
                      .unique()
                      .order([2, 'desc'])
                      // .sort()
                      .each(function (d, j) {
                          select.append('<option value="' + d + '">' + d + '</option>');
                      });
                    });

                    recordTable.columns("3").every(function () {
                      var column = this;
                      //console.log(column);
                      let select = $('#priority-filter').on('change', function () {
                          if($(this).val().length > 0 && $(this).val()!='Select...'){
                              var val = $.fn.dataTable.util.escapeRegex($('option:selected',this).text());
                              column.search(val ? '^' + val + '$' : '', true, false).draw();//
                          }else{
                              column.search('').draw();
                          }
                      });
                      select.find('option').not(':first').remove();
                      column
                      .data()
                      .unique()
                      .order([3, 'asc'])
                      .sort()
                      .each(function (d, j) {
                          select.append('<option value="' + d + '">' + d + '</option>');
                      });
                    });
          }
		      reDrawRecordTable(data.record);

          $(".form-control").on("change input blur", function(){
              $(this).css({"borderColor":"#1d1d1d77"});
          });

          $(document).on('shown.bs.modal', "#new-record-modal", function (e) {
              $("#category").empty().append('<option value="">Select</option><option value="add-new">Add new</option>');
              if(data.categories){                
				          data.categories.forEach(function(index){
                    $("#category").append('<option value="'+index.id+'">'+index.title+'</option>');
                });
              }
              $("#title").focus();
          });
    
          $("#category").on("change", function(){
              if($(this).val()=='add-new'){
                  $(this).css({"display":"none"});
                  
                  $("#category-new").css({"display":"block"});
                  $("#category-new").val('').focus();
              }
          });

          $(".show-hide-password").on("click", function(){
              let input = $(this).parents(".input-group").children("input");
              if(input.attr("type")=="password"){
                  input.attr("type", "text");
              }else{
                  input.attr("type", "password");
              }
          });

      $("#new-record-save").on("click", function(){
            let is_validated = validateForm('#new-record-modal');
            if(is_validated){	
                if($("#category").val() > 0){
                    let data = {title: $("#title").val(),
                                  link: $("#link").val(),
                                  category_id: $("#category").val(),
                                  priority: $("#priority").val(),
                                  username: $("#username").val(),
                                  password: $("#password").val()
                                };
                    addRecord(data);
                }else{
				            let category_id = $("#category").text();
                    addCategory(category_id).then(function(category){
                      let data = {title: $("#title").val(),
                                  link: $("#link").val(),
                                  category_id: category.id,
                                  priority: $("#priority").val(),
                                  username: $("#username").val(),
                                  password: $("#password").val()
                                  };
                        addRecord(data);
                    });
                }            
            }else{
                $("#new-record-modal-title").text("Form Validation Error").css({"color":"#ff0000"});
                return false;
            }
      });
	
      $("#withlogin").on("change", function(){
          if($(this).is(':checked')){
              $(".extra-inputs").css({"display":"block"});
              $("#username").attr("required", "required");
              $("#password").attr("required", "required");
          }else{
              $(".extra-inputs").css({"display":"none"});
              $("#username").removeAttr("required");
              $("#password").removeAttr("required");
          }
      });

      $("#category-new").on("blur",function(){
          if(!$(this).val()){
              $("#category").val("").change();
              $("#category").attr("required", "required");
              $("#category").css({"display":"block"});
              $(this).css({"display":"none"});
          }
      });

      $("#category-new").on("change",function(){
		      let categoryValue = capitalizeWord($(this).val().toLowerCase());
          if(!$(this).val()){ 
              $("#category").val("").change();
              $("#category").attr("required", "required");
              $("#category").css({"display":"block"});
              $(this).css({"display":"none"});
          }else{
              let is_uniqueCategory = false;
             $("#category option").each(function(){
                    if($(this).text() == categoryValue){
					              is_uniqueCategory = true;
						            $(this).prop('selected', true).change();
                    }
              });
              if(!is_uniqueCategory){
				          $("#category").append("<option value='0' selected>"+categoryValue+"</option>").change();
              }

              $("#category").css({"display":"block"});
			        $("#category-new").css({"display":"none"});
              $("#category").attr("required", "required");
          }
      })

	  }) // end document.ready

  }); //end .then load

  function validateForm(scope){
      let error_count=0;
      $(scope).find(".form-control").each(function(index){
          let attr = $(this).attr('required');
          //console.log($(this).prop("tagName").toLowerCase());
          //console.log($(this).val());
          if(typeof attr !== 'undefined' && attr !== false){
              if(!$(this).val() && ['input', 'textarea'].includes($(this).prop("tagName").toLowerCase()) ){
                if(error_count == 0){
                  $(this).focus();
                }
                $(this).parent('div').find('label > span').text('(Field is required)');
                $(this).css("border","solid 1px #ff0000");
                error_count++;
              }else if($(this).prop("tagName").toLowerCase()=='select' && !$(this, 'option:selected').val()){
                  if(error_count == 0){
                  $(this).focus();
                  }
                  $(this).css("border","solid 1px #ff0000");
                  $(this).parent('div').find('label > span').text('(Field is required)');
                  error_count++;
              }
          }
      });      
      return error_count>0 ? false : true;
  }
  function capitalizeWord(str){
      return str.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
  }
	</script>
</body>

</html>
